{% extends "base.html" %}

{% block title %}Users Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-people"></i> Users Management</h1>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Telegram ID</th>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Tariff Plan</th>
                        <th>Balance</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table">
                    {% for user in users %}
                    <tr id="user-{{ user.id }}">
                        <td>{{ user.id }}</td>
                        <td>{{ user.telegram_id }}</td>
                        <td>{{ user.username or '-' }}</td>
                        <td>{{ user.first_name }} {{ user.last_name or '' }}</td>
                        <td>
                            {% if user.tariff_plan %}
                            <span class="badge bg-info">{{ user.tariff_plan.name }}</span>
                            {% else %}
                            <span class="badge bg-secondary">No Plan</span>
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(user.balance) }}</td>
                        <td>
                            {% if user.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editUser({{ user.id }})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="assignTariff({{ user.id }})">
                                <i class="bi bi-card-list"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="edit-user-id">
                    <div class="mb-3">
                        <label class="form-label">Balance</label>
                        <input type="number" class="form-control" id="edit-balance" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="edit-status">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Tariff Modal -->
<div class="modal fade" id="assignTariffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Tariff Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignTariffForm">
                    <input type="hidden" id="assign-user-id">
                    <div class="mb-3">
                        <label class="form-label">Select Tariff Plan</label>
                        <select class="form-select" id="assign-tariff-plan-id" required>
                            <option value="">-- Select Plan --</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTariffAssignment()">Assign</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function editUser(userId) {
    const response = await fetch(`/api/users/${userId}`);
    const user = await response.json();
    
    document.getElementById('edit-user-id').value = user.id;
    document.getElementById('edit-balance').value = user.balance;
    document.getElementById('edit-status').value = user.is_active.toString();
    
    new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

async function saveUser() {
    const userId = document.getElementById('edit-user-id').value;
    const balance = parseFloat(document.getElementById('edit-balance').value);
    const isActive = document.getElementById('edit-status').value === 'true';
    
    const response = await fetch(`/api/users/${userId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({balance, is_active: isActive})
    });
    
    if (response.ok) {
        location.reload();
    } else {
        alert('Error updating user');
    }
}

async function assignTariff(userId) {
    document.getElementById('assign-user-id').value = userId;
    
    // Load tariff plans
    const response = await fetch('/api/tariff-plans/');
    const plans = await response.json();
    
    const select = document.getElementById('assign-tariff-plan-id');
    select.innerHTML = '<option value="">-- Select Plan --</option>';
    plans.forEach(plan => {
        const option = document.createElement('option');
        option.value = plan.id;
        option.textContent = `${plan.name} (${plan.videos_per_day}/day, ${plan.videos_per_order}/order)`;
        select.appendChild(option);
    });
    
    new bootstrap.Modal(document.getElementById('assignTariffModal')).show();
}

async function saveTariffAssignment() {
    const userId = parseInt(document.getElementById('assign-user-id').value);
    const tariffPlanId = parseInt(document.getElementById('assign-tariff-plan-id').value);
    
    if (!tariffPlanId) {
        alert('Please select a tariff plan');
        return;
    }
    
    const response = await fetch('/api/tariff-plans/assign', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId, tariff_plan_id: tariffPlanId})
    });
    
    if (response.ok) {
        location.reload();
    } else {
        alert('Error assigning tariff plan');
    }
}
</script>
{% endblock %}
